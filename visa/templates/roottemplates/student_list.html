{% extends "roottemplates/base.html" %}

{% block custom_css %}
{% load static %}
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/brands.min.css" integrity="sha512-8RxmFOVaKQe/xtg6lbscU9DU0IRhURWEuiI0tXevv+lXbAHfkpamD4VKFQRto9WgfOJDwOZ74c/s9Yesv3VvIQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/fontawesome.min.css" integrity="sha512-d0olNN35C6VLiulAobxYHZiXJmq+vl+BGIgAxQtD5+kqudro/xNMvv2yIHAciGHpExsIbKX3iLg+0B6d0k4+ZA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/sweetalert2@10">

  <link rel="stylesheet" href={% static "assets/dist/vendors/feather/feather.css"%}>
  <link rel="stylesheet" href={% static "assets/dist/vendors/mdi/css/materialdesignicons.min.css"%}>
  <link rel="stylesheet" href={% static "assets/dist/vendors/ti-icons/css/themify-icons.css"%}>
  <link rel="stylesheet" href={% static "assets/dist/vendors/typicons/typicons.css"%}>
  <link rel="stylesheet" href={% static "assets/dist/vendors/simple-line-icons/css/simple-line-icons.css"%}>
  <link rel="stylesheet" href={% static "assets/dist/vendors/css/vendor.bundle.base.css"%}>
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" href={% static "assets/dist/css/vertical-layout-light/style.css"%}>
  <!-- endinject -->
  <link rel="shortcut icon" href={% static "assets/dist/images/favicon.png" %}/>
  
  <style>
    /* Add custom styles for DataTables */
    #active-consultant-table,
    #suspend-consultant-table,
    #rootStudentList,
    #activeStudentList {
      border-collapse: collapse;
      width: 100%;
    }

    #active-consultant-table th,
    #activeStudentList th,
    #activeStudentList td,
    #rootStudentList th,
    #rootStudentList td,
    #active-consultant-table td,
    #suspend-consultant-table th,
    #suspend-consultant-table td {
      border: 1px solid #ddd; /* Add border to table cells */
      padding: 8px;
      text-align: left;
    }

    #active-consultant-table th,
    #rootStudentList th,
    #suspend-consultant-table th {
      background-color: #f2f2f2; /* Add background color to header cells */
    }
    .dataTables_wrapper .dataTable .btn, .dataTables_wrapper .dataTable .swal2-modal .swal2-buttonswrapper .swal2-styled, .swal2-modal .swal2-buttonswrapper .dataTables_wrapper .dataTable .swal2-styled, .dataTables_wrapper .dataTable .ajax-upload-dragdrop .ajax-file-upload, .ajax-upload-dragdrop .dataTables_wrapper .dataTable .ajax-file-upload {
      padding: 0.5rem 1rem;
      vertical-align: top;
  }

    .badge-text-black {
        color: black;
    }
    /* Add styles for maintaining distance between tables */
    #secondaryResultsTable_${student.id}, #higherResultsTable_${student.id} {
      margin-top: 20px; /* Adjust the margin as needed */
    }

</style>

  
  {% endblock custom_css %}

{% load static %}
{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-12">
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="tabs">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link active" id="home-tab" data-toggle="tab" href="#pending" role="tab" aria-controls="pending"
                aria-selected="true">Pending Student</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="active-tab" data-toggle="tab" href="#active" role="tab" aria-controls="active"
                aria-selected="false">Active Student</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="Verified-tab" data-toggle="tab" href="#Verified" role="tab" aria-controls="Verified"
                aria-selected="false">Verified Student</a>
            </li>
        
         
         
        
        
          </ul>
        </div>
      </nav>
    </div>
  </div>
  
  <div class="row justify-content-center">
    <div class="col-md-12">
      <div class="tab-content">
        <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="home-tab">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title mb-4">Student</h4>

              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}

              <table id="rootStudentList" class="table table-bordered">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Student Name</th>
                    <th>Student Phone</th>
                    <th>Student Email</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in inactive_students %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{ user.full_name }}</td>
                      <td>{{ user.phone }}</td>
                      <td>{{ user.email }}</td>
                      <td>
                        


                        <button type="button" class="btn btn-info details-btn"
                        data-toggle="modal" data-target="#detailsModal" data-student-id="{{ user.id }}">
                        View Details
                    </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% for user in inactive_students %}
              <div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalTitle" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="detailsModalTitle">Pending Student Details</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td><strong>Name:</strong></td>
                                        <td id="studentname"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Email:</strong></td>
                                        <td id="studentEmail"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Phone:</strong></td>
                                        <td id="studentPhone"></td>
                                    </tr>
                               
                                    <tr>
                                        <td><strong>Gender:</strong></td>
                                        <td id="studentGender"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Status:</strong></td>
                                        <td id="studentStatus">
                                            <!-- Badge to display the status dynamically -->
                                            <span class="badge" id="statusBadge"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Created At:</strong></td>
                                        <td id="studentCreatedAt"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success activate-student-btn" data-student-id="{{ user.id }}">
                                Activate Account
                            </button>
                            
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            </div>
          </div>
        </div>
     
        <div class="tab-pane fade" id="active" role="tabpanel" aria-labelledby="active-tab">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title mb-4">Active Students</h4>
              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
              <table id="activeStudentList" class="table table-bordered">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Student Name</th>
                    <th>Student Phone</th>
                    <th>Student Email</th>
             
                    <th>Gender</th>
                    
                    <th>Created At</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="activeStudentListBody">
                  <!-- Placeholder for dynamic content -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="Verified" role="tabpanel" aria-labelledby="Verified-tab">
          <table class="table" id="verifiedStudentList">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Gender</th>
                <th>Created At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="verifiedStudentListBody">
              <!-- Placeholder for dynamic content -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</div>




{% endblock content %}


{% block custom_js %}
<script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    $(document).ready(function() {
        $('#rootStudentList').DataTable({
          dom: 'Bfrtip',
          buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
          ]
        });
    }
    )
</script>
<script>
    function showStudentDetails(studentId) {
        $.ajax({
            url: `/inactive_students_details/${studentId}/`, // Replace with your API endpoint
            type: 'GET',
            success: function(response) {
                var studentDetails = response.student_details;
    
                // Update the modal content with the fetched student details
                $('#studentname').text(studentDetails.full_name);
                $('#studentEmail').text(studentDetails.email);
                $('#studentPhone').text(studentDetails.phone);
               
                $('#studentGender').text(studentDetails.gender);
    
                // Set the status badge dynamically based on the value of status
                var statusBadge = $('#statusBadge');
                statusBadge.text(studentDetails.status);
                
                // Apply different styling based on the status value
                if (studentDetails.status == 0) {
                    statusBadge.addClass('badge-warning').addClass('badge-text-black').text('Pending');
                } else if (studentDetails.status == 1) {
                    statusBadge.addClass('badge-success').addClass('badge-text-black').text('Active');
                } else if (studentDetails.status == 2) {
                    statusBadge.addClass('badge-info').addClass('badge-text-black').text('Verified');
                }
    
                $('#studentCreatedAt').text(studentDetails.created_at);
    
                // Show the modal
                $('#detailsModal').modal('show');
            },
            
            error: function(error) {
                console.error('Error fetching student details:', error);
            }
        });
    }
    
    $('.details-btn').on('click', function() {
        var studentId = $(this).data('student-id');
        showStudentDetails(studentId);
    });
    

    // Attach click event handler to the "Close" button in the modal
    $('#detailsModal').on('hidden.bs.modal', function () {
        // Reload the page when the modal is closed
        location.reload();
    });
    </script>
    <script>
        function activateStudentAccount(studentId) {
            // Check if studentId is defined
            if (studentId === undefined) {
                console.error('Student ID is undefined.');
                return;
            }
    
            // Display a SweetAlert2 confirmation dialog
            Swal.fire({
                title: 'Activate Confirmation',
                text: 'Are you sure you want to activate this student account?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#007bff',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Activate'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Fetch the activation view for the selected student
                    fetch(`/activate_student_account/${studentId}/`, {
                        method: 'POST',  // Assuming your activation view handles POST requests
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')  // Ensure to include the CSRF token
                        },
                        // Additional headers or body if needed
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Display a success message using SweetAlert2
                        Swal.fire({
                            title: 'Success',
                            text: data.message,
                            icon: 'success'
                        }).then((result) => {
                            // Reload the page after the SweetAlert2 modal is closed
                            location.reload();
                        });
                        // Optionally, you can perform additional actions after activation
                    })
                    .catch(error => {
                        // Display an error message using SweetAlert2
                        Swal.fire({
                            title: 'Error',
                            text: 'Error activating student account',
                            icon: 'error'
                        });
                        console.error('Error activating student account:', error);
                    });
                }
            });
        }
    
        // Attach click event to the "Activate Account" button
        $('.activate-student-btn').on('click', function() {
            var studentId = $(this).data('student-id');
            activateStudentAccount(studentId);
        });
    
        // Function to get the CSRF token from the cookies
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        fetchActiveStudents();
      });
    
      function fetchActiveStudents() {
        fetch('/active_student_list/')
          .then(response => response.json())
          .then(data => {
            updateActiveStudentsTable(data.active_students_details);
    
            // Initialize DataTables with export buttons
            $('#activeStudentList').DataTable({
              dom: 'Bfrtip', // 'B' for buttons
              buttons: [
                'copyHtml5',
                'excelHtml5',
                'csvHtml5',
                'pdfHtml5'
              ]
            });
          })
          .catch(error => {
            console.error('Error fetching active students:', error);
          });
      }
    
      function updateActiveStudentsTable(activeStudentsDetails) {
        var tableBody = document.getElementById('activeStudentListBody');
        tableBody.innerHTML = '';
    
        var genderMap = { 0: 'Male', 1: 'Female' };
    
        activeStudentsDetails.forEach(function (student, index) {
          var row = tableBody.insertRow(index);
          row.insertCell(0).textContent = index + 1;
          row.insertCell(1).textContent = student.full_name;
          row.insertCell(2).textContent = student.phone;
          row.insertCell(3).textContent = student.email;
          row.insertCell(4).textContent = genderMap[student.gender];
          row.insertCell(5).textContent = student.created_at;
    
          var actionButtonCell = row.insertCell(6);
          var viewDetailsButton = document.createElement('button');
          viewDetailsButton.type = 'button';
          viewDetailsButton.className = 'btn btn-info view-details-btn';
          viewDetailsButton.textContent = 'View Details';
          viewDetailsButton.dataset.studentId = student.id;
          viewDetailsButton.dataset.toggle = 'modal';
          viewDetailsButton.dataset.target = '#detailsactiveModal_' + student.id; // Unique ID for each modal
          actionButtonCell.appendChild(viewDetailsButton);
    
          // Add a modal for each student
          var modalHtml = `
            <div class="modal fade" id="detailsactiveModal_${student.id}" tabindex="-1" role="dialog" aria-labelledby="detailsactiveModalTitle_${student.id}" aria-hidden="true">
              <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="detailsactiveModalTitle_${student.id}">Active Student Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <table class="table table-bordered">
                      <tbody>
                        <tr>
                          <td><strong>Name:</strong></td>
                          <td id="studentname_${student.id}"></td>
                        </tr>
                        <tr>
                          <td><strong>Email:</strong></td>
                          <td id="studentEmail_${student.id}"></td>
                        </tr>
                        <tr>
                          <td><strong>Phone:</strong></td>
                          <td id="studentPhone_${student.id}"></td>
                        </tr>
                        <tr>
                          <td><strong>Address:</strong></td>
                          <td id="studentGender_${student.id}"></td>
                        </tr>
                        <tr>
                          <td><strong>Status:</strong></td>
                          <td id="studentStatus_${student.id}">
                            <!-- Badge to display the status dynamically -->
                            <span class="badge" id="statusBadge_${student.id}"></span>
                          </td>
                        </tr>
                        <tr>
                          <td><strong>Created At:</strong></td>
                          <td id="studentCreatedAt_${student.id}"></td>
                        </tr>
                      </tbody>
                    </table>
                    <br>
                    <!-- Results table -->
                    <h5>Secondary Results</h5>
                    <table class="table table-bordered" id="secondaryResultsTable_${student.id}">
                      <thead>
                        <tr>
                          <th>Board</th>
                          <th>Result</th>
                          <th>Roll No</th>
                          <th>Reg No</th>
                          <th>Certificate No</th>
                          <th>Passing Year</th>
                          <th>Certificate Copy</th>
                          <th>Results Created At</th>
                          <th>Results Updated At</th>
                        </tr>
                      </thead>
                      <tbody id="secondaryResultsTableBody_${student.id}">
                        <!-- Placeholder for dynamic content -->
                      </tbody>
                    </table>
                    <br>
                    <br>
                    <h5>Higher Results</h5>
                    <table class="table table-bordered" id="higherResultsTable_${student.id}">
                      <thead>
                        <tr>
                          <th>Board</th>
                          <th>Result</th>
                          <th>Roll No</th>
                          <th>Reg No</th>
                          <th>Certificate No</th>
                          <th>Passing Year</th>
                          <th>Certificate Copy</th>
                          <th>Results Created At</th>
                          <th>Results Updated At</th>
                        </tr>
                      </thead>
                      <tbody id="higherResultsTableBody_${student.id}">
                        <!-- Placeholder for dynamic content -->
                      </tbody>
                    </table>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success verify-student-btn" data-student-id="${student.id}">
                        Verify
                    </button>
                </div>
                
                </div>
              </div>
            </div>`;
          $('body').append(modalHtml);
        });
      }
    
      function showactiveStudentDetails(studentId) {
        $.ajax({
          url: `/active_student_details/${studentId}/`,
          type: 'GET',
          success: function (response) {
            var studentDetails = response.student_details;
            var resultsDetails = response.results_details;
    
            console.log('Fetched student details:', studentDetails);
            console.log('Fetched results details:', resultsDetails);
    
            // Populate fields in the modal for student details
            $('#studentname_' + studentId).text(studentDetails.full_name);
            $('#studentEmail_' + studentId).text(studentDetails.email);
            $('#studentPhone_' + studentId).text(studentDetails.phone);
            $('#studentGender_' + studentId).text(studentDetails.address);
    
            var statusBadge = $('#statusBadge_' + studentId);
            statusBadge.text(studentDetails.status);
    
            if (studentDetails.status == 0) {
              statusBadge.addClass('badge-warning').addClass('badge-text-black').text('Pending');
            } else if (studentDetails.status == 1) {
              statusBadge.addClass('badge-success').addClass('badge-text-black').text('Active');
            } else if (studentDetails.status == 2) {
              statusBadge.addClass('badge-info').addClass('badge-text-black').text('Verified');
            }
    
            $('#studentCreatedAt_' + studentId).text(studentDetails.created_at);
    
            // Populate results tables
            var secondaryResultsTableBody = document.getElementById('secondaryResultsTableBody_' + studentId);
            var higherResultsTableBody = document.getElementById('higherResultsTableBody_' + studentId);
            secondaryResultsTableBody.innerHTML = '';
            higherResultsTableBody.innerHTML = '';
    
            resultsDetails.forEach(function (result) {
              var resultRow;
              if (result.result_type === 'Secondary') {
                resultRow = secondaryResultsTableBody.insertRow();
              } else if (result.result_type === 'Higher') {
                resultRow = higherResultsTableBody.insertRow();
              }
    
              resultRow.insertCell(0).textContent = result.board;
              resultRow.insertCell(1).textContent = result.result;
              resultRow.insertCell(2).textContent = result.roll_no;
              resultRow.insertCell(3).textContent = result.reg_no;
              resultRow.insertCell(4).textContent = result.certificate_no;
              resultRow.insertCell(5).textContent = result.passing_year;
              resultRow.insertCell(6).textContent = result.certificate_copy;
              resultRow.insertCell(7).textContent = result.created_at;
              resultRow.insertCell(8).textContent = result.updated_at;
            });
    
            $('#detailsactiveModal_' + studentId).modal('show');
          },
    
          error: function (error) {
            console.error('Error fetching student details:', error);
          }
        });
      }
    
      // Attach click event handler to the "View Details" button in the table
      $('#activeStudentListBody').on('click', '.view-details-btn', function () {
        var studentId = $(this).data('studentId');
        showactiveStudentDetails(studentId);
      });
    
      // Attach click event handler to the "Close" button in the modal
      $('[id^="detailsactiveModal_"]').on('hidden.bs.modal', function () {
        location.reload();
      });
    </script>
    <script>
      // Function to verify a student account
      function verifyStudentAccount(studentId) {
          // Check if studentId is defined
          if (studentId === undefined) {
              console.error('Student ID is undefined.');
              return;
          }
  
          // Display a SweetAlert2 confirmation dialog
          Swal.fire({
              title: 'Verification Confirmation',
              text: 'Are you sure you want to verify this student account?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#28a745',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Verify'
          }).then((result) => {
              if (result.isConfirmed) {
                  // Fetch the verification view for the selected student
                  fetch(`/verify_student_account/${studentId}/`, {
                      method: 'POST',  // Assuming your verification view handles POST requests
                      headers: {
                          'X-CSRFToken': getCookie('csrftoken')  // Ensure to include the CSRF token
                      },
                      // Additional headers or body if needed
                  })
                  .then(response => {
                      if (!response.ok) {
                          throw new Error(`HTTP error! Status: ${response.status}`);
                      }
                      return response.json();
                  })
                  .then(data => {
                      // Display a success message using SweetAlert2
                      Swal.fire({
                          title: 'Success',
                          text: data.message,
                          icon: 'success'
                      }).then((result) => {
                          // Reload the page after the SweetAlert2 modal is closed
                          location.reload();
                      });
                      // Optionally, you can perform additional actions after verification
                  })
                  .catch(error => {
                      // Display an error message using SweetAlert2
                      Swal.fire({
                          title: 'Error',
                          text: 'Error verifying student account',
                          icon: 'error'
                      });
                      console.error('Error verifying student account:', error);
                  });
              }
          });
      }
  
      // Attach click event to the "Verify" button
      $('body').on('click', '.verify-student-btn', function () {
          var studentId = $(this).data('student-id');
          verifyStudentAccount(studentId);
      });
  
      // Function to get the CSRF token from the cookies
      function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      fetchVerifiedStudents();
    });
  
    function fetchVerifiedStudents() {
      fetch('/verify_student_list/')
        .then(response => response.json())
        .then(data => {
          updateVerifiedStudentsTable(data.verify_students_details);
  
          // Initialize DataTables with export buttons
          $('#verifiedStudentList').DataTable({
            dom: 'Bfrtip', // 'B' for buttons
            buttons: [
              'copyHtml5',
              'excelHtml5',
              'csvHtml5',
              'pdfHtml5'
            ]
          });
        })
        .catch(error => {
          console.error('Error fetching verified students:', error);
        });
    }
  
    function updateVerifiedStudentsTable(verifyStudentsDetails) {
      var tableBody = document.getElementById('verifiedStudentListBody');
      tableBody.innerHTML = '';
  
      var genderMap = { 0: 'Male', 1: 'Female' };
  
      verifyStudentsDetails.forEach(function (student, index) {
        var row = tableBody.insertRow(index);
        row.insertCell(0).textContent = index + 1;
        row.insertCell(1).textContent = student.full_name;
        row.insertCell(2).textContent = student.phone;
        row.insertCell(3).textContent = student.email;
        row.insertCell(4).textContent = genderMap[student.gender];
        row.insertCell(5).textContent = student.created_at;
  
        var actionButtonCell = row.insertCell(6);
        var viewDetailsButton = document.createElement('button');
        viewDetailsButton.type = 'button';
        viewDetailsButton.className = 'btn btn-info view-details-btn';
        viewDetailsButton.textContent = 'View Details';
        viewDetailsButton.dataset.studentId = student.id;
        viewDetailsButton.dataset.toggle = 'modal';
        viewDetailsButton.dataset.target = '#detailsVerifiedModal_' + student.id; // Unique ID for each modal
        actionButtonCell.appendChild(viewDetailsButton);
  
        // Add a modal for each student
        var modalHtml = `
          <div class="modal fade" id="detailsVerifiedModal_${student.id}" tabindex="-1" role="dialog" aria-labelledby="detailsVerifiedModalTitle_${student.id}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="detailsVerifiedModalTitle_${student.id}">Verified Student Details</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <table class="table table-bordered">
                    <tbody>
                      <tr>
                        <td><strong>Name:</strong></td>
                        <td id="verifiedStudentName_${student.id}"></td>
                      </tr>
                      <tr>
                        <td><strong>Email:</strong></td>
                        <td id="verifiedStudentEmail_${student.id}"></td>
                      </tr>
                      <tr>
                        <td><strong>Phone:</strong></td>
                        <td id="verifiedStudentPhone_${student.id}"></td>
                      </tr>
                      <tr>
                        <td><strong>Address:</strong></td>
                        <td id="verifiedStudentGender_${student.id}"></td>
                      </tr>
                      <tr>
                        <td><strong>Status:</strong></td>
                        <td id="verifiedStudentStatus_${student.id}">
                          <!-- Badge to display the status dynamically -->
                          <span class="badge" id="verifiedStatusBadge_${student.id}"></span>
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Created At:</strong></td>
                        <td id="verifiedStudentCreatedAt_${student.id}"></td>
                      </tr>
                    </tbody>
                  </table>
                  <br>
                  <!-- Results table -->
                  <h5>Secondary Results</h5>
                  <table class="table table-bordered" id="verifiedSecondaryResultsTable_${student.id}">
                    <thead>
                      <tr>
                        <th>Board</th>
                        <th>Result</th>
                        <th>Roll No</th>
                        <th>Reg No</th>
                        <th>Certificate No</th>
                        <th>Passing Year</th>
                        <th>Certificate Copy</th>
                        <th>Results Created At</th>
                        <th>Results Updated At</th>
                      </tr>
                    </thead>
                    <tbody id="verifiedSecondaryResultsTableBody_${student.id}">
                      <!-- Placeholder for dynamic content -->
                    </tbody>
                  </table>
                  <br>
                  <br>
                  <h5>Higher Results</h5>
                  <table class="table table-bordered" id="verifiedHigherResultsTable_${student.id}">
                    <thead>
                      <tr>
                        <th>Board</th>
                        <th>Result</th>
                        <th>Roll No</th>
                        <th>Reg No</th>
                        <th>Certificate No</th>
                        <th>Passing Year</th>
                        <th>Certificate Copy</th>
                        <th>Results Created At</th>
                        <th>Results Updated At</th>
                      </tr>
                    </thead>
                    <tbody id="verifiedHigherResultsTableBody_${student.id}">
                      <!-- Placeholder for dynamic content -->
                    </tbody>
                  </table>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>`;
        $('body').append(modalHtml);
      });
    }
  
    function showVerifiedStudentDetails(studentId) {
      $.ajax({
        url: `/verify_student_details/${studentId}/`,
        type: 'GET',
        success: function (response) {
          var studentDetails = response.student_details;
          var resultsDetails = response.results_details;
  
          console.log('Fetched verified student details:', studentDetails);
          console.log('Fetched verified results details:', resultsDetails);
  
          // Populate fields in the modal for student details
          $('#verifiedStudentName_' + studentId).text(studentDetails.full_name);
          $('#verifiedStudentEmail_' + studentId).text(studentDetails.email);
          $('#verifiedStudentPhone_' + studentId).text(studentDetails.phone);
          $('#verifiedStudentGender_' + studentId).text(studentDetails.address);
  
          // Check if the status is available in the response
          if ('status' in studentDetails) {
            var statusBadge = $('#verifiedStatusBadge_' + studentId);
            statusBadge.text(studentDetails.status);
  
            if (studentDetails.status == 0) {
              statusBadge.addClass('badge-warning').addClass('badge-text-black').text('Pending');
            } else if (studentDetails.status == 1) {
              statusBadge.addClass('badge-success').addClass('badge-text-black').text('Active');
            } else if (studentDetails.status == 2) {
              statusBadge.addClass('badge-info').addClass('badge-text-black').text('Verified');
            }
          }
  
          $('#verifiedStudentCreatedAt_' + studentId).text(studentDetails.created_at);
  
          // Populate results tables
          var verifiedSecondaryResultsTableBody = $('#verifiedSecondaryResultsTableBody_' + studentId);
          var verifiedHigherResultsTableBody = $('#verifiedHigherResultsTableBody_' + studentId);
          verifiedSecondaryResultsTableBody.empty();
          verifiedHigherResultsTableBody.empty();
  
          resultsDetails.forEach(function (result) {
            var resultRow;
            if (result.result_type === 'Secondary') {
              resultRow = verifiedSecondaryResultsTableBody.append('<tr></tr>').children('tr').last();
            } else if (result.result_type === 'Higher') {
              resultRow = verifiedHigherResultsTableBody.append('<tr></tr>').children('tr').last();
            }
  
            resultRow.append('<td>' + result.board + '</td>');
            resultRow.append('<td>' + result.result + '</td>');
            resultRow.append('<td>' + result.roll_no + '</td>');
            resultRow.append('<td>' + result.reg_no + '</td>');
            resultRow.append('<td>' + result.certificate_no + '</td>');
            resultRow.append('<td>' + result.passing_year + '</td>');
            resultRow.append('<td>' + result.certificate_copy + '</td>');
            resultRow.append('<td>' + result.created_at + '</td>');
            resultRow.append('<td>' + result.updated_at + '</td>');
          });
  
          $('#detailsVerifiedModal_' + studentId).modal('show');
        },
  
        error: function (error) {
          console.error('Error fetching verified student details:', error);
        }
      });
    }
  
    // Attach click event handler to the "View Details" button in the table
    $('#verifiedStudentListBody').on('click', '.view-details-btn', function () {
      var studentId = $(this).data('studentId');
      showVerifiedStudentDetails(studentId);
    });
  
    // Attach click event handler to the "Close" button in the modal
    $('[id^="detailsVerifiedModal_"]').on('hidden.bs.modal', function () {
      location.reload();
    });
  </script>
{% endblock custom_js %}